@{
    ViewData["Title"] = "System Reports - KOZY";
}

<style>
    .kozy-reports-header {
        margin-bottom: 2rem;
    }

    .kozy-reports-title {
        font-size: 2rem;
        font-weight: 700;
        color: #2F3030;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .kozy-reports-tabs {
        border: none !important;
        margin-bottom: 2rem;
        background: transparent;
        padding: 0;
        border-radius: 0;
        display: flex !important;
        flex-direction: row !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 1rem;
        flex-wrap: wrap;
        box-shadow: none;
        width: 100%;
    }

    .kozy-tab-link {
        padding: 0.875rem 2rem;
        color: #6B7280;
        text-decoration: none;
        font-weight: 600;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .kozy-tab-link:hover {
        color: #FF8223;
        border-color: #FF8223;
        background: rgba(255, 130, 35, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 130, 35, 0.15);
    }

    .kozy-tab-link.active {
        color: white;
        background: linear-gradient(135deg, #FF8223 0%, #FFA45F 100%);
        border-color: #FF8223;
        box-shadow: 0 4px 8px rgba(255, 130, 35, 0.3);
    }

    .kozy-tab-link.active:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(255, 130, 35, 0.4);
    }

    .kozy-tab-link i {
        font-size: 1.1rem;
    }

    .kozy-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kozy-stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .kozy-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .kozy-stat-card-primary::before {
        background: linear-gradient(90deg, #FF8223 0%, #FFA45F 100%);
    }

    .kozy-stat-card-success::before {
        background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
    }

    .kozy-stat-card-danger::before {
        background: linear-gradient(90deg, #EF4444 0%, #F87171 100%);
    }

    .kozy-stat-card-secondary::before {
        background: linear-gradient(90deg, #6B7280 0%, #9CA3AF 100%);
    }

    .kozy-stat-card-info::before {
        background: linear-gradient(90deg, #68BEB2 0%, #2A5C55 100%);
    }

    .kozy-stat-card-warning::before {
        background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
    }

    .kozy-stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .kozy-stat-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
    }

    .kozy-stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2F3030;
        margin: 0;
    }

    .kozy-chart-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    .kozy-chart-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2F3030;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #E5E7EB;
    }

    .kozy-chart-container {
        position: relative;
        height: 300px;
    }

    .tab-content {
        animation: fadeIn 0.4s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
</style>

<div class="animate-fade-in">
    <div class="kozy-reports-header" style="text-align: center; margin-bottom: 1.5rem;">
        <h1 class="kozy-reports-title" style="justify-content: center;">
            <i class="fa-solid fa-chart-line" style="color: #FF8223;"></i>
            System Reports
        </h1>
    </div>

    <!-- Tabs Navigation - Pill-style buttons for easy navigation -->
    <div class="kozy-reports-tabs" role="tablist">
        <a class="kozy-tab-link active" data-bs-toggle="tab" href="#borrowing" role="tab" aria-selected="true">
            <i class="fa-solid fa-book-open-reader"></i>
            <span>Borrowing Report</span>
        </a>
        <a class="kozy-tab-link" data-bs-toggle="tab" href="#inventory" role="tab" aria-selected="false">
            <i class="fa-solid fa-book"></i>
            <span>Inventory Report</span>
        </a>
        <a class="kozy-tab-link" data-bs-toggle="tab" href="#member" role="tab" aria-selected="false">
            <i class="fa-solid fa-users"></i>
            <span>Member Report</span>
        </a>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 2rem;">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Borrowing Report -->
        <div class="tab-pane fade show active" id="borrowing" role="tabpanel">
            <!-- Statistics Cards -->
            <div class="kozy-stats-grid">
                <div class="kozy-stat-card kozy-stat-card-primary">
                    <div class="kozy-stat-title">Total Borrowings</div>
                    <h2 class="kozy-stat-value">@ViewBag.TotalBorrowings</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-success">
                    <div class="kozy-stat-title">Active</div>
                    <h2 class="kozy-stat-value">@ViewBag.ActiveBorrowings</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-danger">
                    <div class="kozy-stat-title">Overdue</div>
                    <h2 class="kozy-stat-value">@ViewBag.OverdueBorrowings</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-secondary">
                    <div class="kozy-stat-title">Returned</div>
                    <h2 class="kozy-stat-value">@ViewBag.ReturnedBorrowings</h2>
                </div>
            </div>

            <div class="row">
                <!-- Borrowing Status Pie Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Borrowing Status Distribution</div>
                        <div class="kozy-chart-container">
                            <canvas id="borrowingStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Borrowing Trends Line Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Borrowing Trends (Last 6 Months)</div>
                        <div class="kozy-chart-container">
                            <canvas id="borrowingTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Report -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            <!-- Statistics Cards -->
            <div class="kozy-stats-grid">
                <div class="kozy-stat-card kozy-stat-card-info">
                    <div class="kozy-stat-title">Total Books</div>
                    <h2 class="kozy-stat-value">@ViewBag.TotalBooks</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-success">
                    <div class="kozy-stat-title">Available</div>
                    <h2 class="kozy-stat-value">@ViewBag.AvailableBooks</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-warning">
                    <div class="kozy-stat-title">Borrowed</div>
                    <h2 class="kozy-stat-value">@ViewBag.BorrowedBooks</h2>
                </div>
            </div>

            <div class="row">
                <!-- Books by Genre Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Books by Genre (Top 10)</div>
                        <div class="kozy-chart-container">
                            <canvas id="booksByGenreChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Borrowed Books Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Most Borrowed Books (Top 10)</div>
                        <div class="kozy-chart-container">
                            <canvas id="topBorrowedBooksChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Book Status Pie Chart -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Book Availability Status</div>
                        <div class="kozy-chart-container">
                            <canvas id="bookStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Member Report -->
        <div class="tab-pane fade" id="member" role="tabpanel">
            <!-- Statistics Cards -->
            <div class="kozy-stats-grid">
                <div class="kozy-stat-card kozy-stat-card-primary">
                    <div class="kozy-stat-title">Total Members</div>
                    <h2 class="kozy-stat-value">@ViewBag.TotalMembers</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-success">
                    <div class="kozy-stat-title">Active Members</div>
                    <h2 class="kozy-stat-value">@ViewBag.ActiveMembers</h2>
                </div>
                <div class="kozy-stat-card kozy-stat-card-secondary">
                    <div class="kozy-stat-title">Inactive Members</div>
                    <h2 class="kozy-stat-value">@ViewBag.InactiveMembers</h2>
                </div>
            </div>

            <div class="row">
                <!-- Top Borrowers Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Top Borrowers (Top 10)</div>
                        <div class="kozy-chart-container">
                            <canvas id="topBorrowersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Member Activity Chart -->
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Member Activity Status</div>
                        <div class="kozy-chart-container">
                            <canvas id="memberActivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members by Role Chart -->
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="kozy-chart-card">
                        <div class="kozy-chart-header">Members by Role</div>
                        <div class="kozy-chart-container">
                            <canvas id="membersByRoleChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* Chart.js library for data visualization *@
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        @* ============================================
           BOOTSTRAP TAB NAVIGATION
           ============================================ *@
        @* Initialize and handle Bootstrap 5 tab switching for report sections *@
        document.addEventListener('DOMContentLoaded', function() {
            const tabLinks = document.querySelectorAll('.kozy-tab-link');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            @* Handle tab click events to switch between report sections *@
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    
                    @* Remove active state from all tabs and panes *@
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabPanes.forEach(p => {
                        p.classList.remove('show', 'active');
                    });
                    
                    @* Activate clicked tab *@
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    
                    @* Display corresponding tab pane content *@
                    const targetPane = document.querySelector(targetId);
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                    
                    @* Trigger Bootstrap tab component to ensure proper state management *@
                    const tab = new bootstrap.Tab(this);
                    tab.show();
                });
                
                @* Handle Bootstrap's shown event to maintain active state consistency *@
                link.addEventListener('shown.bs.tab', function() {
                    tabLinks.forEach(l => {
                        l.classList.remove('active');
                        l.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                });
            });
        });

        @* ============================================
           BORROWING REPORT CHARTS
           ============================================ *@
        @* Pie chart displaying borrowing status distribution *@
        const borrowingStatusCtx = document.getElementById('borrowingStatusChart');
        if (borrowingStatusCtx) {
            new Chart(borrowingStatusCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Active', 'Overdue', 'Returned', 'Cancelled'],
                    datasets: [{
                        data: [@ViewBag.ActiveBorrowings, @ViewBag.OverdueBorrowings, @ViewBag.ReturnedBorrowings, @(ViewBag.CancelledBorrowings ?? 0)],
                        backgroundColor: ['#10B981', '#EF4444', '#6B7280', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Borrowing Trends Line Chart with KOZY colors
        const borrowingTrendsCtx = document.getElementById('borrowingTrendsChart');
        if (borrowingTrendsCtx) {
            @{
                var borrowingsByMonth = ViewBag.BorrowingsByMonth as IEnumerable<dynamic>;
            }
            @if (borrowingsByMonth != null && borrowingsByMonth.Any())
            {
                <text>
                new Chart(borrowingTrendsCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [@Html.Raw(string.Join(",", borrowingsByMonth.Select(x => $"'{x.Month}'")))],
                        datasets: [{
                            label: 'Borrowings',
                            data: [@Html.Raw(string.Join(",", borrowingsByMonth.Select(x => x.Count)))],
                            borderColor: '#FF8223',
                            backgroundColor: 'rgba(255, 130, 35, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#FF8223',
                            pointBorderColor: '#FFFFFF',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                </text>
            }
        }

        // Books by Genre Chart
        const booksByGenreCtx = document.getElementById('booksByGenreChart');
        if (booksByGenreCtx) {
            @{
                var booksByGenre = ViewBag.BooksByGenre as IEnumerable<dynamic>;
            }
            @if (booksByGenre != null && booksByGenre.Any())
            {
                <text>
                new Chart(booksByGenreCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [@Html.Raw(string.Join(",", booksByGenre.Select(x => $"'{x.Genre}'")))],
                        datasets: [{
                            label: 'Number of Books',
                            data: [@Html.Raw(string.Join(",", booksByGenre.Select(x => x.Count)))],
                            backgroundColor: '#68BEB2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                </text>
            }
        }

        // Top Borrowed Books Chart
        const topBorrowedBooksCtx = document.getElementById('topBorrowedBooksChart');
        if (topBorrowedBooksCtx) {
            @{
                var topBorrowedBooks = ViewBag.TopBorrowedBooks as IEnumerable<dynamic>;
            }
            @if (topBorrowedBooks != null && topBorrowedBooks.Any())
            {
                <text>
                new Chart(topBorrowedBooksCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [@Html.Raw(string.Join(",", topBorrowedBooks.Select(x => $"'{x.Title}'")))],
                        datasets: [{
                            label: 'Times Borrowed',
                            data: [@Html.Raw(string.Join(",", topBorrowedBooks.Select(x => x.BorrowCount)))],
                            backgroundColor: '#FF8223'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                </text>
            }
        }

        // Book Status Pie Chart
        const bookStatusCtx = document.getElementById('bookStatusChart');
        if (bookStatusCtx) {
            new Chart(bookStatusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Borrowed'],
                    datasets: [{
                        data: [@ViewBag.AvailableBooks, @ViewBag.BorrowedBooks],
                        backgroundColor: ['#10B981', '#F59E0B']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Top Borrowers Chart
        const topBorrowersCtx = document.getElementById('topBorrowersChart');
        if (topBorrowersCtx) {
            @{
                var topBorrowers = ViewBag.TopBorrowers as IEnumerable<dynamic>;
            }
            @if (topBorrowers != null && topBorrowers.Any())
            {
                <text>
                new Chart(topBorrowersCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [@Html.Raw(string.Join(",", topBorrowers.Select(x => $"'{x.UserName}'")))],
                        datasets: [{
                            label: 'Books Borrowed',
                            data: [@Html.Raw(string.Join(",", topBorrowers.Select(x => x.BorrowCount)))],
                            backgroundColor: '#FF8223'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                </text>
            }
        }

        // Member Activity Chart
        const memberActivityCtx = document.getElementById('memberActivityChart');
        if (memberActivityCtx) {
            new Chart(memberActivityCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Active', 'Inactive'],
                    datasets: [{
                        data: [@ViewBag.ActiveMembers, @ViewBag.InactiveMembers],
                        backgroundColor: ['#10B981', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Members by Role Chart
        const membersByRoleCtx = document.getElementById('membersByRoleChart');
        if (membersByRoleCtx) {
            @{
                var membersByRole = ViewBag.MembersByRole as IEnumerable<dynamic>;
            }
            @if (membersByRole != null && membersByRole.Any())
            {
                <text>
                new Chart(membersByRoleCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: [@Html.Raw(string.Join(",", membersByRole.Select(x => $"'{x.Role}'")))],
                        datasets: [{
                            label: 'Number of Members',
                            data: [@Html.Raw(string.Join(",", membersByRole.Select(x => x.Count)))],
                            backgroundColor: '#68BEB2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                </text>
            }
        }
    </script>
}
